name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - develop
      - 'release/*'
      - 'hotfix/*'

jobs:
  validate-pr:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Check if ClickUp ticket ID exists in PR body or title
            const clickupPattern = /DUPLO-\d+/;
            const clickupUrlPattern = /https:\/\/app\.clickup\.com\/t\/\d+\/DUPLO-\d+/;

            const hasClickupId = clickupPattern.test(prBody) || clickupPattern.test(prTitle);
            const hasClickupUrl = clickupUrlPattern.test(prBody);

            if (!hasClickupId && !hasClickupUrl) {
              core.setFailed('❌ PR validation failed: ClickUp ticket ID (DUPLO-XXXXX) is required in either the PR title or description.\n\nPlease add a ClickUp ticket reference in one of these formats:\n1. In the PR title: "DUPLO-12345: Your PR title"\n2. In the PR description: "DUPLO-12345"\n3. As a full URL: "https://app.clickup.com/t/8655600/DUPLO-12345"');
              return;
            }

            // Check if PR description has required sections
            const requiredSections = [
              'ClickUp Ticket',
              'Overview',
              'Summary of changes',
              'Testing performed'
            ];

            const missingSections = requiredSections.filter(section => {
              const sectionPattern = new RegExp(`##\\s*${section}`, 'i');
              return !sectionPattern.test(prBody);
            });

            if (missingSections.length > 0) {
              core.setFailed(`❌ PR validation failed: Missing required sections in PR description:\n${missingSections.map(s => `  - ${s}`).join('\n')}\n\nPlease use the PR template and fill in all required sections.`);
              return;
            }

            // Check if ClickUp Ticket section has content (not just empty)
            const clickupSectionMatch = prBody.match(/##\s*ClickUp Ticket[\s\S]*?(?=##|$)/i);
            if (clickupSectionMatch) {
              const clickupSection = clickupSectionMatch[0];
              // Remove comments and check if there's actual content
              const contentWithoutComments = clickupSection.replace(/<!--[\s\S]*?-->/g, '').trim();
              const hasContent = contentWithoutComments.split('\n').some(line => {
                const trimmed = line.replace(/^##\s*ClickUp Ticket/i, '').trim();
                return trimmed.length > 0 && !trimmed.startsWith('**ClickUp Ticket ID:**');
              });

              if (!hasContent) {
                core.setFailed('❌ PR validation failed: ClickUp Ticket section is empty.\n\nPlease add your ClickUp ticket ID or URL in the "ClickUp Ticket" section.');
                return;
              }
            }

            core.info('✅ PR validation passed: All required sections are present and ClickUp ticket ID is included.');

      - name: Add validation comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = '✅ **PR Validation Passed**\n\nAll required sections are present and ClickUp ticket ID is included.';

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Validation')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }
